{"ast":null,"code":"import _slicedToArray from\"/home/floslv/Flo/Dev/Learning/MikeCodeur/react-hooks-avances/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _defineProperty from\"/home/floslv/Flo/Dev/Learning/MikeCodeur/react-hooks-avances/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _objectSpread from\"/home/floslv/Flo/Dev/Learning/MikeCodeur/react-hooks-avances/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";// useDebugValue\n// http://localhost:3000/alone/final/0.js\nimport*as React from'react';import{ErrorBoundary}from'react-error-boundary';import{fetchMarvel,fetchMarvelById,fetchMarvelsList,MarvelSearchForm,ErrorDisplay,MarvelPersoView}from'../marvel';import'../02-styles.css';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";var cacheFormatDebugValue=function cacheFormatDebugValue(cache){return\"`Expiration \".concat(cache.expire,\"  : ` => Elements :\").concat(cache.data.length);};var MarvelCacheContext=/*#__PURE__*/React.createContext();function marvelCacheReducer(state,action){var ttl=1000*10;var expire=Date.now()+ttl;switch(action.type){case'ADD_MARVEL':{return _objectSpread(_objectSpread({},state),{},_defineProperty({},action.marvelName,{data:action.marvelData,expire:expire}));}case'ADD_MARVEL_LIST':{return _objectSpread(_objectSpread({},state),{},_defineProperty({},\"\".concat(action.marvelName,\"-list\"),{data:action.marvelData,expire:expire}));}default:{throw new Error(\"action impossible: \".concat(action.type));}}}function MarvelCacheProvider(props){var _React$useReducer=React.useReducer(marvelCacheReducer,{}),_React$useReducer2=_slicedToArray(_React$useReducer,2),cache=_React$useReducer2[0],dispatch=_React$useReducer2[1];return/*#__PURE__*/_jsx(MarvelCacheContext.Provider,_objectSpread({value:[cache,dispatch]},props));}function useMarvelCache(){var context=React.useContext(MarvelCacheContext);if(!context){throw new Error('useMarvelCache doit être utilisé avec MarvelCacheProvider');}return context;}var reducer=function reducer(state,action){switch(action.type){case'fetching':return{status:'fetching',data:null,error:null};case'done':return{status:'done',data:action.payload,error:null};case'fail':return{status:'fail',data:null,error:action.error};default:throw new Error('Action non supporté');}};function useFetchData(){var _React$useReducer3=React.useReducer(reducer,{data:null,error:null,status:'idle'}),_React$useReducer4=_slicedToArray(_React$useReducer3,2),state=_React$useReducer4[0],dispatch=_React$useReducer4[1];var data=state.data,error=state.error,status=state.status;var execute=React.useCallback(function(promise){dispatch({type:'fetching'});promise.then(function(marvel){return dispatch({type:'done',payload:marvel});})[\"catch\"](function(error){return dispatch({type:'fail',error:error});});},[]);var setData=React.useCallback(function(data){return dispatch({type:'done',payload:data});},[dispatch]);return{data:data,error:error,status:status,execute:execute,setData:setData};}function useFindMarvelByName(marvelName){var _useMarvelCache=useMarvelCache(),_useMarvelCache2=_slicedToArray(_useMarvelCache,2),cache=_useMarvelCache2[0],dispatch=_useMarvelCache2[1];React.useDebugValue(cache);var _useFetchData=useFetchData(),data=_useFetchData.data,error=_useFetchData.error,status=_useFetchData.status,execute=_useFetchData.execute,setData=_useFetchData.setData;React.useEffect(function(){var _cache$marvelName;if(!marvelName){return;}else if(((_cache$marvelName=cache[marvelName])===null||_cache$marvelName===void 0?void 0:_cache$marvelName.data)&&Date.now()<cache[marvelName].expire){setData(cache[marvelName].data);}else{execute(fetchMarvel(marvelName).then(function(marvelData){dispatch({type:'ADD_MARVEL',marvelName:marvelName,marvelData:marvelData});return marvelData;}));}},[marvelName,execute,cache,setData,dispatch]);return{data:data,error:error,status:status};}function useFindMarvelList(marvelName){var _useMarvelCache3=useMarvelCache(),_useMarvelCache4=_slicedToArray(_useMarvelCache3,2),cache=_useMarvelCache4[0],dispatch=_useMarvelCache4[1];React.useDebugValue(cache[\"\".concat(marvelName,\"-list\")],cacheFormatDebugValue);var _useFetchData2=useFetchData(),data=_useFetchData2.data,error=_useFetchData2.error,status=_useFetchData2.status,execute=_useFetchData2.execute,setData=_useFetchData2.setData;React.useEffect(function(){var _cache$;if(!marvelName){return;}else if(((_cache$=cache[\"\".concat(marvelName,\"-list\")])===null||_cache$===void 0?void 0:_cache$.data)&&Date.now()<cache[\"\".concat(marvelName,\"-list\")].expire){setData(cache[\"\".concat(marvelName,\"-list\")].data);}else{execute(fetchMarvelsList(marvelName).then(function(marvelData){dispatch({type:'ADD_MARVEL_LIST',marvelName:marvelName,marvelData:marvelData});return marvelData;}));}},[marvelName,execute,cache,setData,dispatch]);return{data:data,error:error,status:status};}function Marvel(_ref){var marvelName=_ref.marvelName;var state=useFindMarvelByName(marvelName,fetchMarvelById);var marvel=state.data,error=state.error,status=state.status;if(status==='fail'){throw error;}else if(status==='idle'){return'enter un nom de Marvel';}else if(status==='fetching'){return'chargement en cours ...';}else if(status==='done'){return/*#__PURE__*/_jsx(MarvelPersoView,{marvel:marvel});}}function MarvelList(_ref2){var marvelName=_ref2.marvelName;var state=useFindMarvelList(marvelName,fetchMarvelById);var marvels=state.data,error=state.error,status=state.status;if(status==='fail'){throw error;}else if(status==='idle'){return'enter un nom de Marvel';}else if(status==='fetching'){return'chargement en cours ...';}else if(status==='done'){return/*#__PURE__*/_jsx(_Fragment,{children:marvels.map(function(marvel){return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"hr\",{style:{background:'grey'}}),/*#__PURE__*/_jsx(MarvelPersoView,{marvel:marvel})]},marvel.id);})});}}function App(){var _React$useState=React.useState(''),_React$useState2=_slicedToArray(_React$useState,2),marvelName=_React$useState2[0],setMarvelName=_React$useState2[1];var _React$useState3=React.useState(''),_React$useState4=_slicedToArray(_React$useState3,2),searchList=_React$useState4[0],setSearchList=_React$useState4[1];var handleSearch=function handleSearch(name){setMarvelName(name);};return/*#__PURE__*/_jsxs(\"div\",{className:\"marvel-app\",children:[/*#__PURE__*/_jsxs(\"label\",{children:[/*#__PURE__*/_jsx(\"input\",{type:\"checkbox\",checked:searchList,onChange:function onChange(e){return setSearchList(e.target.checked);}}),' ',\"Chercher une liste ?\"]}),/*#__PURE__*/_jsx(MarvelSearchForm,{marvelName:marvelName,onSearch:handleSearch}),/*#__PURE__*/_jsx(MarvelCacheProvider,{children:/*#__PURE__*/_jsx(\"div\",{className:\"marvel-detail\",children:/*#__PURE__*/_jsx(ErrorBoundary,{FallbackComponent:ErrorDisplay,children:searchList?/*#__PURE__*/_jsx(MarvelList,{marvelName:marvelName}):/*#__PURE__*/_jsx(Marvel,{marvelName:marvelName})},marvelName)})})]});}export default App;","map":{"version":3,"sources":["/home/floslv/Flo/Dev/Learning/MikeCodeur/react-hooks-avances/src/final/07.js"],"names":["React","ErrorBoundary","fetchMarvel","fetchMarvelById","fetchMarvelsList","MarvelSearchForm","ErrorDisplay","MarvelPersoView","cacheFormatDebugValue","cache","expire","data","length","MarvelCacheContext","createContext","marvelCacheReducer","state","action","ttl","Date","now","type","marvelName","marvelData","Error","MarvelCacheProvider","props","useReducer","dispatch","useMarvelCache","context","useContext","reducer","status","error","payload","useFetchData","execute","useCallback","promise","then","marvel","setData","useFindMarvelByName","useDebugValue","useEffect","useFindMarvelList","Marvel","MarvelList","marvels","map","background","id","App","useState","setMarvelName","searchList","setSearchList","handleSearch","name","e","target","checked"],"mappings":"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","sourcesContent":["// useDebugValue\n// http://localhost:3000/alone/final/0.js\n\nimport * as React from 'react'\nimport {ErrorBoundary} from 'react-error-boundary'\nimport {\n  fetchMarvel,\n  fetchMarvelById,\n  fetchMarvelsList,\n  MarvelSearchForm,\n  ErrorDisplay,\n  MarvelPersoView,\n} from '../marvel'\nimport '../02-styles.css'\n\nconst cacheFormatDebugValue = cache =>\n  `\\`Expiration ${cache.expire}  : \\` => Elements :${cache.data.length}`\n\nconst MarvelCacheContext = React.createContext()\n\nfunction marvelCacheReducer(state, action) {\n  const ttl = 1_000 * 10\n  const expire = Date.now() + ttl\n  switch (action.type) {\n    case 'ADD_MARVEL': {\n      return {...state, [action.marvelName]: {data: action.marvelData, expire}}\n    }\n    case 'ADD_MARVEL_LIST': {\n      return {\n        ...state,\n        [`${action.marvelName}-list`]: {data: action.marvelData, expire},\n      }\n    }\n    default: {\n      throw new Error(`action impossible: ${action.type}`)\n    }\n  }\n}\n\nfunction MarvelCacheProvider(props) {\n  const [cache, dispatch] = React.useReducer(marvelCacheReducer, {})\n  return <MarvelCacheContext.Provider value={[cache, dispatch]} {...props} />\n}\n\nfunction useMarvelCache() {\n  const context = React.useContext(MarvelCacheContext)\n  if (!context) {\n    throw new Error('useMarvelCache doit être utilisé avec MarvelCacheProvider')\n  }\n  return context\n}\n\nconst reducer = (state, action) => {\n  switch (action.type) {\n    case 'fetching':\n      return {status: 'fetching', data: null, error: null}\n    case 'done':\n      return {status: 'done', data: action.payload, error: null}\n    case 'fail':\n      return {status: 'fail', data: null, error: action.error}\n    default:\n      throw new Error('Action non supporté')\n  }\n}\n\nfunction useFetchData() {\n  const [state, dispatch] = React.useReducer(reducer, {\n    data: null,\n    error: null,\n    status: 'idle',\n  })\n  const {data, error, status} = state\n\n  const execute = React.useCallback(promise => {\n    dispatch({type: 'fetching'})\n    promise\n      .then(marvel => dispatch({type: 'done', payload: marvel}))\n      .catch(error => dispatch({type: 'fail', error}))\n  }, [])\n\n  const setData = React.useCallback(\n    data => dispatch({type: 'done', payload: data}),\n    [dispatch],\n  )\n\n  return {data, error, status, execute, setData}\n}\n\nfunction useFindMarvelByName(marvelName) {\n  const [cache, dispatch] = useMarvelCache()\n\n  React.useDebugValue(cache)\n\n  const {data, error, status, execute, setData} = useFetchData()\n  React.useEffect(() => {\n    if (!marvelName) {\n      return\n    } else if (\n      cache[marvelName]?.data &&\n      Date.now() < cache[marvelName].expire\n    ) {\n      setData(cache[marvelName].data)\n    } else {\n      execute(\n        fetchMarvel(marvelName).then(marvelData => {\n          dispatch({type: 'ADD_MARVEL', marvelName, marvelData})\n          return marvelData\n        }),\n      )\n    }\n  }, [marvelName, execute, cache, setData, dispatch])\n  return {data, error, status}\n}\n\nfunction useFindMarvelList(marvelName) {\n  const [cache, dispatch] = useMarvelCache()\n\n  React.useDebugValue(cache[`${marvelName}-list`], cacheFormatDebugValue)\n\n  const {data, error, status, execute, setData} = useFetchData()\n  React.useEffect(() => {\n    if (!marvelName) {\n      return\n    } else if (\n      cache[`${marvelName}-list`]?.data &&\n      Date.now() < cache[`${marvelName}-list`].expire\n    ) {\n      setData(cache[`${marvelName}-list`].data)\n    } else {\n      execute(\n        fetchMarvelsList(marvelName).then(marvelData => {\n          dispatch({type: 'ADD_MARVEL_LIST', marvelName, marvelData})\n          return marvelData\n        }),\n      )\n    }\n  }, [marvelName, execute, cache, setData, dispatch])\n  return {data, error, status}\n}\n\nfunction Marvel({marvelName}) {\n  const state = useFindMarvelByName(marvelName, fetchMarvelById)\n  const {data: marvel, error, status} = state\n  if (status === 'fail') {\n    throw error\n  } else if (status === 'idle') {\n    return 'enter un nom de Marvel'\n  } else if (status === 'fetching') {\n    return 'chargement en cours ...'\n  } else if (status === 'done') {\n    return <MarvelPersoView marvel={marvel} />\n  }\n}\n\nfunction MarvelList({marvelName}) {\n  const state = useFindMarvelList(marvelName, fetchMarvelById)\n  const {data: marvels, error, status} = state\n  if (status === 'fail') {\n    throw error\n  } else if (status === 'idle') {\n    return 'enter un nom de Marvel'\n  } else if (status === 'fetching') {\n    return 'chargement en cours ...'\n  } else if (status === 'done') {\n    return (\n      <>\n        {marvels.map(marvel => {\n          return (\n            <div key={marvel.id}>\n              <hr style={{background: 'grey'}} />\n              <MarvelPersoView marvel={marvel} />\n            </div>\n          )\n        })}\n      </>\n    )\n  }\n}\n\nfunction App() {\n  const [marvelName, setMarvelName] = React.useState('')\n  const [searchList, setSearchList] = React.useState('')\n  const handleSearch = name => {\n    setMarvelName(name)\n  }\n  return (\n    <div className=\"marvel-app\">\n      <label>\n        <input\n          type=\"checkbox\"\n          checked={searchList}\n          onChange={e => setSearchList(e.target.checked)}\n        />{' '}\n        Chercher une liste ?\n      </label>\n      <MarvelSearchForm marvelName={marvelName} onSearch={handleSearch} />\n      <MarvelCacheProvider>\n        <div className=\"marvel-detail\">\n          <ErrorBoundary key={marvelName} FallbackComponent={ErrorDisplay}>\n            {searchList ? (\n              <MarvelList marvelName={marvelName} />\n            ) : (\n              <Marvel marvelName={marvelName} />\n            )}\n          </ErrorBoundary>\n        </div>\n      </MarvelCacheProvider>\n    </div>\n  )\n}\n\nexport default App\n"]},"metadata":{},"sourceType":"module"}